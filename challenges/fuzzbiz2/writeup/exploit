#!/usr/bin/env python3
import sys
import os
import socket


def recv_until(sock: socket.socket, token: bytes, *, max_bytes: int = 2_000_000) -> bytes:
    buf = bytearray()
    while token not in buf:
        chunk = sock.recv(4096)
        if not chunk:
            break
        buf += chunk
        if len(buf) > max_bytes:
            break
    return bytes(buf)

def main():
    if len(sys.argv) != 4:
        print(f"Usage: {sys.argv[0]} <host> <port> <file>")
        sys.exit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    file_path = sys.argv[3]

    # Ensure file exists
    if not os.path.isfile(file_path):
        print(f"[!] File not found: {file_path}")
        sys.exit(1)

    # Read the file contents
    with open(file_path, 'rb') as f:
        payload = f.read()

    payload_length = len(payload)

    with socket.create_connection((host, port), timeout=5) as sock:
        sock.settimeout(5)

        recv_until(sock, b"Enter your payload length:")
        sock.sendall(f"{payload_length}\n".encode())

        recv_until(sock, b"Enter your payload:")
        sock.sendall(payload)
        try:
            sock.shutdown(socket.SHUT_WR)
        except OSError:
            pass

        out = bytearray()
        while True:
            try:
                chunk = sock.recv(4096)
            except socket.timeout:
                break
            if not chunk:
                break
            out += chunk
        print(out.decode(errors="ignore"))

if __name__ == '__main__':
    main()