#!/usr/bin/env python3
import pathlib
import sys


KEY = bytes([0xC3, 0x7A, 0x15, 0xE9, 0x4B, 0x2D, 0x90, 0xFE])
TAG = b"FWCMPv1\x00"


def ror8(x: int, r: int) -> int:
    r &= 7
    return ((x >> r) | ((x << (8 - r)) & 0xFF)) & 0xFF


def deobfuscate_value(val: bytes) -> bytes:
    if len(val) != 40:
        raise ValueError("expected 40 bytes")
    out = bytearray(40)
    for i in range(40):
        x = val[i]
        x ^= (0x3C ^ ((i * 11) & 0xFF)) & 0xFF
        x = ror8(x, (i % 7) + 1)
        x ^= (0xA5 + (i * 7)) & 0xFF
        x ^= KEY[i % len(KEY)]
        out[i] = x
    return bytes(out)


def main() -> int:
    here = pathlib.Path(__file__).resolve()
    chall_dir = here.parents[1]
    fw = chall_dir / "src" / "extrafirm"
    data = fw.read_bytes()

    off = data.find(TAG)
    if off < 0:
        print("tag not found", file=sys.stderr)
        return 2

    val = data[off + len(TAG) : off + len(TAG) + 40]
    if len(val) != 40:
        print("truncated value", file=sys.stderr)
        return 2

    flag_padded = deobfuscate_value(val)
    flag = flag_padded.split(b"\x00", 1)[0]
    print(flag.decode("ascii", errors="replace"))
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

