#!/usr/bin/env python3
import socket
import sys


HOST = sys.argv[1] if len(sys.argv) > 1 else "127.0.0.1"
PORT = int(sys.argv[2]) if len(sys.argv) > 2 else 28653


def recv_until(s: socket.socket, needle: bytes, limit: int = 1 << 20) -> bytes:
    buf = bytearray()
    while needle not in buf:
        chunk = s.recv(4096)
        if not chunk:
            break
        buf += chunk
        if len(buf) > limit:
            break
    return bytes(buf)


def main() -> int:
    with socket.create_connection((HOST, PORT), timeout=5.0) as s:
        # part0 prompt
        sys.stdout.buffer.write(recv_until(s, b"max 1024 hex chars):\n"))
        s.sendall(b"00\n")

        # part1 prompt
        sys.stdout.buffer.write(recv_until(s, b"max 1024 hex chars):\n"))
        s.sendall(b"00\n")

        # Read the remaining output until the service closes the connection.
        while True:
            chunk = s.recv(4096)
            if not chunk:
                break
            sys.stdout.buffer.write(chunk)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

