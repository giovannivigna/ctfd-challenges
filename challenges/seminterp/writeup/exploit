#!/usr/bin/env python3
import socket
import sys


RULE = """rules:
  - id: seminterp.sqli
    languages: [python]
    message: sqli
    severity: ERROR
    pattern: query = "SELECT email FROM users WHERE username = '%s'" % username

  - id: seminterp.cmdi
    languages: [python]
    message: cmdi
    severity: ERROR
    pattern: subprocess.check_output(..., shell=True)

  - id: seminterp.pickle
    languages: [python]
    message: pickle
    severity: ERROR
    pattern: pickle.loads(...)
"""


def main() -> int:
    if len(sys.argv) != 3:
        print(f"usage: {sys.argv[0]} HOST PORT", file=sys.stderr)
        return 2
    host = sys.argv[1]
    port = int(sys.argv[2])

    with socket.create_connection((host, port), timeout=10) as s:
        banner = s.recv(65535)
        sys.stdout.buffer.write(banner)
        sys.stdout.flush()

        payload = RULE + "\nEOF\n"
        s.sendall(payload.encode())

        while True:
            data = s.recv(65535)
            if not data:
                break
            sys.stdout.buffer.write(data)
            sys.stdout.flush()
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
