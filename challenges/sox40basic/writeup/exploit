#!/usr/bin/env python3

import sys
import re

from pwn import context, remote


def extract_challenge_phrase(transcript: bytes) -> str:
    # Line looks like: "Your challenge phrase is: <phrase>\n"
    m = re.search(rb"Your challenge phrase is:\s*(.+)\r?\n", transcript)
    if not m:
        raise RuntimeError("Could not find challenge phrase in transcript")
    return m.group(1).decode(errors="replace").strip()


def extract_ciphertext(transcript: bytes) -> str:
    # Line looks like: "Here is your encrypted text (encoded with base64): <cipher>\n"
    m = re.search(
        rb"Here is your encrypted text \(encoded with base64\):\s*([A-Za-z0-9+/=]+)\r?\n",
        transcript,
    )
    if not m:
        raise RuntimeError("Could not find ciphertext in transcript")
    return m.group(1).decode()


def main() -> int:
    if len(sys.argv) != 3:
        print(f"Usage: {sys.argv[0]} HOST PORT", file=sys.stderr)
        return 2

    host = sys.argv[1]
    port = int(sys.argv[2])

    context.log_level = "info"

    a = remote(host, port)
    b = remote(host, port)

    # Connection A: reach the challenge phrase prompt.
    a.recvuntil(b"Enter some text:")
    a.sendline(b"hello")
    a_transcript = a.recvuntil(b"Your encrypted phrase:")

    phrase = extract_challenge_phrase(a_transcript)
    print(f"[+] Challenge phrase: {phrase}")

    # Connection B: use it as an encryption oracle for that phrase.
    b.recvuntil(b"Enter some text:")
    b.sendline(phrase.encode())
    b_transcript = b.recvuntil(b"Your encrypted phrase:")
    cipher = extract_ciphertext(b_transcript)
    print(f"[+] Ciphertext: {cipher}")

    # Send oracle-produced ciphertext back to connection A.
    a.sendline(cipher.encode())
    sys.stdout.buffer.write(a.recvall(timeout=2))
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


