#!/usr/bin/env python3

import re
import socket
import sys


QUERY = """import cpp

from Function f
where f.getName() = "anotherFunction"
select f, f.getName()
"""


def recv_until(sock: socket.socket, needle: bytes, max_bytes: int = 5_000_000) -> bytes:
    buf = bytearray()
    while needle not in buf:
        chunk = sock.recv(4096)
        if not chunk:
            break
        buf += chunk
        if len(buf) > max_bytes:
            raise RuntimeError("received too much data without seeing expected prompt")
    return bytes(buf)


def main() -> int:
    if len(sys.argv) != 3:
        print(f"usage: {sys.argv[0]} HOST PORT", file=sys.stderr)
        return 2

    host = sys.argv[1]
    port = int(sys.argv[2])

    with socket.create_connection((host, port), timeout=10) as s:
        banner = recv_until(s, b"Submit your query", max_bytes=5_000_000)
        sys.stdout.buffer.write(banner)

        payload = QUERY + "\nDONE\n"
        s.sendall(payload.encode())

        buf = bytearray()
        while True:
            chunk = s.recv(4096)
            if not chunk:
                break
            buf += chunk
            sys.stdout.buffer.write(chunk)

            m = re.search(rb"flag:\s*(ictf\{[^}]+\})", banner + bytes(buf))
            if m:
                print(m.group(1).decode())
                return 0

    return 1


if __name__ == "__main__":
    raise SystemExit(main())

