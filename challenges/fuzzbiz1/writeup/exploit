#!/usr/bin/env python3
import os
import socket
import sys


def main() -> None:
    if len(sys.argv) != 4:
        print(f"Usage: {sys.argv[0]} <host> <port> <file>")
        raise SystemExit(1)

    host = sys.argv[1]
    port = int(sys.argv[2])
    file_path = sys.argv[3]

    if not os.path.isfile(file_path):
        print(f"[!] File not found: {file_path}")
        raise SystemExit(1)

    with open(file_path, "rb") as f:
        payload = f.read()

    with socket.create_connection((host, port), timeout=5) as s:
        s.settimeout(5)

        def recv_until(token: bytes) -> bytes:
            buf = b""
            while token not in buf:
                chunk = s.recv(4096)
                if not chunk:
                    break
                buf += chunk
            return buf

        recv_until(b"Enter your payload length:")
        s.sendall(f"{len(payload)}\n".encode())
        recv_until(b"Enter your payload:")
        s.sendall(payload)

        out = b""
        try:
            while True:
                chunk = s.recv(4096)
                if not chunk:
                    break
                out += chunk
        except socket.timeout:
            pass

        print(out.decode(errors="ignore"))


if __name__ == "__main__":
    main()
