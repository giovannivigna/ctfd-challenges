#!/usr/bin/env python3
import os
import sys

from Crypto.Cipher import AES

IV = bytes.fromhex("656d756c6f75735f69765f5f32303236")  # b"emulous_iv__2026"
CIPHERTEXT = bytes.fromhex(
    "9c2920d3b93e5ca8648a001a7d45d0c6"
    "925f6f3aab80096e97b32d95faea8215"
)


def pkcs7_unpad(b: bytes) -> bytes | None:
    if not b or len(b) % 16 != 0:
        return None
    pad = b[-1]
    if pad < 1 or pad > 16:
        return None
    if b[-pad:] != bytes([pad]) * pad:
        return None
    return b[:-pad]


def decrypt(key: bytes) -> bytes | None:
    key16 = key[:16].ljust(16, b"\x00")
    pt = AES.new(key16, AES.MODE_CBC, iv=IV).decrypt(CIPHERTEXT)
    return pkcs7_unpad(pt)


def is_printable_ascii(b: bytes) -> bool:
    return all(0x20 <= x <= 0x7E for x in b)


def main() -> int:
    wordlist = sys.argv[1] if len(sys.argv) > 1 else "/usr/share/dict/words"
    if not os.path.exists(wordlist):
        print(f"wordlist not found: {wordlist}", file=sys.stderr)
        return 2

    def try_word(w: bytes) -> bytes | None:
        if not w:
            return None
        pt = decrypt(w)
        if pt is None:
            return None
        if is_printable_ascii(pt) and pt.startswith(b"ictf{") and pt.endswith(b"}"):
            return pt
        return None

    with open(wordlist, "rb") as f:
        for raw in f:
            w = raw.strip()
            pt = try_word(w)
            if pt is not None:
                print(w.decode(errors="replace"))
                print(pt.decode("ascii"))
                return 0

    # Some wordlists may not contain the intended password. Try it explicitly.
    w = b"tremulation"
    pt = try_word(w)
    if pt is not None:
        print(w.decode())
        print(pt.decode("ascii"))
        return 0

    print("no solution found")
    return 1


if __name__ == "__main__":
    raise SystemExit(main())

